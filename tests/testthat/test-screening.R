context("screening")

susps <- as.data.table(patRoonData::targets)

susps[, InChI := babelConvert(SMILES, "smi", "inchi")]
susps[, neutralMass := getNeutralMassFromSMILES(SMILES)]
susps[, formula := convertToFormulaBabel(SMILES, "smi")]
susps[, adduct := "[M+H]+"]
susps[name %in% c("TBA", "TPA"), adduct := "[M]+"]

fGroups <- getTestFGroups(getTestAnaInfo())
scr <- screenSuspects(fGroups, susps)
scrF <- screenSuspects(getFeatures(fGroups), susps)
scrSMI <- screenSuspects(fGroups, susps[, c("name", "rt", "adduct", "SMILES")])

suspsMissing <- copy(susps)
suspsMissing[1, mz := NA]
suspsMissing[2, neutralMass := NA]
suspsMissing[3, formula := NA_character_]
suspsMissing[4, SMILES := ""]
suspsMissing[5, InChI := ""]
suspsMissingRow <- copy(susps)
suspsMissingRow[2, c("mz", "neutralMass", "formula", "SMILES", "InChI") := NA]

test_that("suspect screening is OK", {
    expect_equal(nrow(scr), nrow(susps))
    expect_length(unique(scrF$name), nrow(susps))
    expect_known_value(scr, testFile("screening"))
    expect_known_value(scrF[, -"feature"], testFile("screening-feat"))
    expect_length(groupFeaturesScreening(fGroups, scr), nrow(susps))

    # check suspects without retention
    expect_gte(nrow(screenSuspects(fGroups, susps[, -3])), nrow(scr))
    expect_gte(nrow(screenSuspects(getFeatures(fGroups), susps[, -3])), nrow(scrF))
    
    # alternative ion mass calculations
    expect_equal_scr(scr, scrSMI, tolerance = 1E-3) # higher tolerance due to inaccurate mz column in patRoonData::targets
    expect_equal_scr(scrSMI, screenSuspects(fGroups, susps[, c("name", "rt", "adduct", "InChI")]))
    expect_equal_scr(scrSMI, screenSuspects(fGroups, susps[, c("name", "rt", "adduct", "neutralMass")]))
    expect_equal_scr(scrSMI, screenSuspects(fGroups, susps[, c("name", "rt", "adduct", "formula")]))

    # same, with missing data (having 2 options for ion mass calculation should be sufficient)
    expect_equal_scr(scrSMI, screenSuspects(fGroups, suspsMissing[, c("name", "rt", "adduct", "mz", "neutralMass")]),
                 tolerance = 1E-3)
    expect_equal_scr(scrSMI, screenSuspects(fGroups, suspsMissing[, c("name", "rt", "adduct", "neutralMass", "formula")]))
    expect_equal_scr(scrSMI, screenSuspects(fGroups, suspsMissing[, c("name", "rt", "adduct", "formula", "SMILES")]))
    expect_equal_scr(scrSMI, screenSuspects(fGroups, suspsMissing[, c("name", "rt", "adduct", "SMILES", "InChI")]))
    
    # adduct argument
    expect_equal_scr(screenSuspects(fGroups, susps[name %in% c("TBA", "TPA")]),
                     screenSuspects(fGroups, susps[name %in% c("TBA", "TPA"), -"adduct"], adduct = "[M]+"))

    # certain Linux/JVM combinations (e.g. current CI Docker image) give Java StackOverflows...
    testthat::skip_on_os("linux")
    expect_warning(screenSuspects(fGroups, suspsMissingRow, skipInvalid = TRUE))
    expect_error(screenSuspects(fGroups, suspsMissingRow, skipInvalid = FALSE))
})

# NOTE: try keep this in sync with MF tests for caching purposes
hasMF <- !is.null(getOption("patRoon.path.MetFragCL")) && nzchar(getOption("patRoon.path.MetFragCL"))
if (hasMF)
{
    scrAnn <- getCompScr()
    fGroupsAnn <- getCompFGroups()
    plists <- generateMSPeakLists(fGroupsAnn, "mzr")
    compsMF <- callMF(fGroupsAnn, plists)
    compsMFMoNa <- callMF(fGroupsAnn, plists, scoreTypes = c("fragScore", "individualMoNAScore"))
    forms <- generateFormulas(fGroupsAnn, "genform", plists)
    
    ann <- annotateSuspectList(scrAnn, fGroupsAnn)
    annMF <- annotateSuspectList(scrAnn, fGroupsAnn, MSPeakLists = plists, formulas = forms, compounds = compsMF)
    annMoNa <- annotateSuspectList(scrAnn, fGroupsAnn, MSPeakLists = plists, formulas = forms, compounds = compsMFMoNa)
    annOnlyForms <- annotateSuspectList(scrAnn, fGroupsAnn, MSPeakLists = plists, formulas = forms)
    
    scrAnnFrag <- copy(scrAnn)
    scrAnnFrag[name == "1H-benzotriazole", fragments_mz := "92.0495"] # UNDONE: add qualifiers to patRoonData?
    scrAnnFragForm <- copy(scrAnn)
    scrAnnFragForm[name == "1H-benzotriazole", fragments_formula := "C6H5N"] # UNDONE: add qualifiers to patRoonData?
    annFrag <- annotateSuspectList(scrAnnFrag[, -"d_rt"], fGroupsAnn, MSPeakLists = plists)
    annFragRT <- annotateSuspectList(scrAnnFrag, fGroupsAnn, MSPeakLists = plists)
    annFragForm <- annotateSuspectList(scrAnnFragForm[, -"d_rt"], fGroupsAnn, MSPeakLists = plists, compounds = compsMF,
                                       IDLevelRules = defaultIDLevelRules(exLevels = "3a|c"))
}

minIDLevel <- function(l) min(as.integer(gsub("[[:alpha:]]*", "", l)))
test_that("Suspect annotation works", {
    skip_if_not(hasMF)
    
    expect_equal(minIDLevel(ann$estIDLevel), 5)
    expect_equal(minIDLevel(annOnlyForms$estIDLevel), 4)
    expect_equal(minIDLevel(annMF$estIDLevel), 3)
    expect_equal(minIDLevel(annFrag$estIDLevel), 3)
    expect_equal(minIDLevel(annFragForm$estIDLevel), 3)
    expect_equal(minIDLevel(annMoNa$estIDLevel), 2)
    expect_equal(minIDLevel(annFragRT$estIDLevel), 1)
})

TQFile <- file.path(getTestDataPath(), "GlobalResults-TASQ.csv")
TQRes <- fread(TQFile)
fGroupsTQ <- importFeatureGroupsBrukerTASQ(TQFile, getTestAnaInfo())
fGroupsTQ <- filter(fGroupsTQ, blankThreshold = 5, removeBlanks = TRUE)
TQFileNoRT <- file.path(getTestDataPath(), "GlobalResults_noRT-TASQ.csv")
TQResNoRT <- fread(TQFileNoRT)
fGroupsTQNoRT <- importFeatureGroupsBrukerTASQ(TQFileNoRT, getTestAnaInfo())
fGroupsTQNoRT <- filter(fGroupsTQNoRT, blankThreshold = 5, removeBlanks = TRUE)

test_that("TASQ import works", {
    expect_equal(unique(TQRes$Analyte), names(fGroupsTQ))
    expect_known_value(groups(fGroupsTQ), testFile("susp-tasq"))
    expect_known_value(groupInfo(fGroupsTQ), testFile("susp-tasq-gi"))
    expect_known_show(fGroupsTQ, testFile("susp-tasq", text = TRUE))
    
    expect_lt(length(unique(TQResNoRT$Analyte)), length(fGroupsTQNoRT))
    expect_known_value(groups(fGroupsTQNoRT), testFile("susp-tasq-nort"))
    expect_known_value(groupInfo(fGroupsTQNoRT), testFile("susp-tasq-nort-gi"))
    expect_known_show(fGroupsTQNoRT, testFile("susp-tasq-nort", text = TRUE))
})
